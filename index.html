<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tesla IPTV Player - Local M3U</title>
<style>
  body { font-family: Arial, sans-serif; background: #111; color: #eee; margin:0; padding:0; }
  header { background: #222; padding: 10px; text-align: center; font-size: 1.5em; }
  nav { display: flex; justify-content: space-around; background: #333; }
  nav button { flex:1; padding: 10px; background: #333; color: #eee; border:none; cursor:pointer; }
  nav button.active { background: #555; }
  #searchBar { width: 90%; margin: 10px auto; display:block; padding:5px; font-size:1em; }
  section { display:none; padding: 10px; max-height: 70vh; overflow-y: auto; }
  section.active { display:block; }
  ul { list-style:none; padding:0; }
  li { padding:5px 0; cursor:pointer; border-bottom: 1px solid #444; }
  video { width: 100%; margin-top: 10px; }
  #backBtn { position: fixed; top: 10px; right: 10px; padding: 10px 15px; font-size: 1em; background: #f00; color: #fff; border: none; cursor: pointer; display:none; z-index: 1000; }
</style>
</head>
<body>

<header>Tesla IPTV Player (Local M3U)</header>

<nav>
  <button class="tabBtn active" data-tab="live">Live</button>
  <button class="tabBtn" data-tab="movies">Movies</button>
  <button class="tabBtn" data-tab="series">Series</button>
</nav>

<input type="text" id="searchBar" placeholder="Search channels or content">

<section id="live" class="active"><ul id="liveList"></ul></section>
<section id="movies"><ul id="moviesList"></ul></section>
<section id="series"><ul id="seriesList"></ul></section>

<video id="player" controls></video>
<button id="backBtn">Back to List</button>

<script>
  // ==== LOCAL M3U FILE ====
  const M3U_URL = "tesla.m3u"; // must be uploaded next to index.html
  // =======================

  let allChannels = [];

  async function fetchM3U() {
    try {
      const res = await fetch(M3U_URL);
      const text = await res.text();
      parseM3U(text);
      renderChannels();
    } catch(err) {
      console.error("Failed to fetch M3U:", err);
      alert("Could not load M3U file. Make sure tesla.m3u is uploaded.");
    }
  }

  function parseM3U(data) {
    const lines = data.split(/\r?\n/);
    for (let i = 0; i < lines.length; i++) {
      if (lines[i].startsWith("#EXTINF")) {
        const nameMatch = lines[i].match(/,(.*)$/);
        const groupMatch = lines[i].match(/group-title="(.*)"/i);
        const name = nameMatch ? nameMatch[1] : "Unknown";
        const category = groupMatch ? groupMatch[1] : "Live";
        const url = lines[i+1] ? lines[i+1].trim() : "";
        if(url) allChannels.push({name, category, stream_url: url});
      }
    }
  }

  function renderChannels(filter="") {
    const liveList = document.getElementById("liveList");
    const moviesList = document.getElementById("moviesList");
    const seriesList = document.getElementById("seriesList");
    liveList.innerHTML = moviesList.innerHTML = seriesList.innerHTML = "";

    allChannels
      .filter(ch => ch.name.toLowerCase().includes(filter.toLowerCase()))
      .forEach(ch => {
        const li = document.createElement("li");
        li.textContent = ch.name;
        li.onclick = () => playChannel(ch.stream_url);
        if (ch.category.toLowerCase().includes("movie")) moviesList.appendChild(li);
        else if (ch.category.toLowerCase().includes("series")) seriesList.appendChild(li);
        else liveList.appendChild(li);
      });
  }

  function playChannel(url) {
    const player = document.getElementById("player");
    const backBtn = document.getElementById("backBtn");
    player.src = url;
    player.play();
    backBtn.style.display = "block";
    // request fullscreen
    if (player.requestFullscreen) player.requestFullscreen();
    else if (player.webkitRequestFullscreen) player.webkitRequestFullscreen();
    else if (player.msRequestFullscreen) player.msRequestFullscreen();
  }

  document.getElementById("backBtn").addEventListener("click", () => {
    const player = document.getElementById("player");
    const backBtn = document.getElementById("backBtn");
    player.pause();
    player.src = "";
    backBtn.style.display = "none";
    // exit fullscreen
    if (document.exitFullscreen) document.exitFullscreen();
    else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
    else if (document.msExitFullscreen) document.msExitFullscreen();
  });

  document.getElementById("searchBar").addEventListener("input", e => {
    renderChannels(e.target.value);
  });

  document.querySelectorAll(".tabBtn").forEach(btn => {
    btn.addEventListener("click", () => {
      document.querySelectorAll("section").forEach(sec => sec.classList.remove("active"));
      document.querySelectorAll(".tabBtn").forEach(b => b.classList.remove("active"));
      document.getElementById(btn.dataset.tab).classList.add("active");
      btn.classList.add("active");
    });
  });

  fetchM3U();
</script>

</body>
</html>
